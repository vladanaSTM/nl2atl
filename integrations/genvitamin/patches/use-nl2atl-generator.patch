*** Begin Patch
*** Update File: genVITAMIN/api/routes/ai/generate.py
@@
-"""Formula generation endpoints."""
-
-import logging
-from typing import Optional
-
-from fastapi import APIRouter, HTTPException
-from pydantic import BaseModel
-
-from api.schemas.requests import LogicType
-from api.services import get_ai_service
+"""Formula generation endpoints."""
+
+import json
+import logging
+import urllib.error
+import urllib.request
+from typing import Optional
+
+from fastapi import APIRouter, HTTPException
+from pydantic import BaseModel
+
+from api.schemas.requests import LogicType
+from api.services import get_ai_service
+from api.core.config import settings
@@
 # Use shared AIService instance
 ai_service = get_ai_service()
+
+
+def _call_nl2atl(description: str, logic: str) -> Optional[str]:
+    """Call NL2ATL API if configured, otherwise return None."""
+    base_url = settings.NL2ATL_URL
+    if not base_url:
+        return None
+
+    # NL2ATL currently generates ATL only
+    if logic != "ATL":
+        return None
+
+    payload = {
+        "description": description,
+        "model": settings.NL2ATL_MODEL,
+        "few_shot": settings.NL2ATL_FEW_SHOT,
+        "num_few_shot": settings.NL2ATL_NUM_FEW_SHOT,
+        "adapter": settings.NL2ATL_ADAPTER,
+        "max_new_tokens": settings.NL2ATL_MAX_NEW_TOKENS,
+    }
+
+    url = base_url.rstrip("/") + "/generate"
+    timeout = settings.NL2ATL_TIMEOUT
+    data = json.dumps(payload).encode("utf-8")
+
+    request = urllib.request.Request(
+        url,
+        data=data,
+        headers={"Content-Type": "application/json"},
+        method="POST",
+    )
+
+    try:
+        with urllib.request.urlopen(request, timeout=timeout) as response:
+            body = response.read().decode("utf-8")
+            parsed = json.loads(body)
+            return parsed.get("formula")
+    except (urllib.error.URLError, json.JSONDecodeError) as exc:
+        logger.warning(f"NL2ATL call failed: {exc}")
+        return None
@@
 async def generate_formula(request: GenerateFormulaRequest):
@@
-        logger.info(
-            f"Generating {request.logic_type.value} formula using knowledge base first"
-        )
-        # Use AI service to generate the formula (which uses knowledge base internally)
-        formula = await ai_service.generate_formula(
-            description=request.description, logic=request.logic_type.value
-        )
+        # Try NL2ATL first if configured
+        formula = _call_nl2atl(request.description, request.logic_type.value)
+        if formula:
+            logger.info("Generated formula using NL2ATL")
+        else:
+            logger.info(
+                f"Generating {request.logic_type.value} formula using knowledge base first"
+            )
+            # Use AI service to generate the formula (which uses knowledge base internally)
+            formula = await ai_service.generate_formula(
+                description=request.description, logic=request.logic_type.value
+            )
*** End Patch
